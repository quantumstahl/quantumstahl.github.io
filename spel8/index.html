
<html>
    <head>
        <meta name="viewport" content="user-scalable=no, shrink-to-fit=no">
        <meta charset="utf-8">
        <meta name="keywords" content="mobilspel, mobilegames, js games, javascript games">
        <link rel="icon" href="images/guarddown1.png" type="image/vnd.microsoft.icon" />
	<title>Test4</title>
        
        <script src="js/Game4.js"></script>
        
        
        
        
    </head>
    <body>
        <canvas id="myCanvas" width="10" height="10" style="border:0px solid black"></canvas>
        
        <script>

            const canvas = document.getElementById("myCanvas");
            const ctx = canvas.getContext("2d");
            document.getElementById("myCanvas").style.margin = "-8px -8px -8px -8px";
            document.getElementById("myCanvas").style.width=window.innerWidth;
            document.getElementById("myCanvas").style.height=window.innerHeight;

            game = new Game4("Spelet");
            var audio = new Audio('sounds/wow.mp3');
            audio.loop = true;
             
             const context = new (window.AudioContext || window.webkitAudioContext)();
             const audio2 = async url => {   
             const source = context.createBufferSource(); 
                const audioBuffer = await fetch(url)
                  .then(res => res.arrayBuffer())
                  .then(ArrayBuffer => context.decodeAudioData(ArrayBuffer)); 
                source.buffer = audioBuffer;
                source.connect(context.destination);
                source.start();
            };

            
            document.addEventListener("touchstart" , function(e) {
                e.preventDefault();
                    try{if(audio.paused){ 
                        audio.play();
                    }
                    }catch(error){};
                    if(context.state === 'suspended'){context.suspend();context.resume();}           
            });

            
            
            document.addEventListener("visibilitychange", event => {
                if (document.visibilityState === "visible") {
                        audio.pause();audio.src = 'sounds/wow.mp3';context.resume();
                        
                }
                else {
                   audio.pause(); audio.src = "";context.suspend();
              }
          });

           
            
            
            let keysPressed = {};
                document.addEventListener('click', (event) => {
        
               
                try{if(audio.paused){ 
                        audio.play();
                    }
                }catch(error){};
             });

            
            let keyState = {
                w: false,
                a: false,
                s: false,
                d: false
            };
            
            document.addEventListener("keydown", function(e) {
                if (e.key === "w") keyState.w = true;
                if (e.key === "a") keyState.a = true;
                if (e.key === "s") keyState.s = true;
                if (e.key === "d") keyState.d = true;
            });

            document.addEventListener("keyup", function(e) {
                if (e.key === "w") keyState.w = false;
                if (e.key === "a") keyState.a = false;
                if (e.key === "s") keyState.s = false;
                if (e.key === "d") keyState.d = false;
            });
            
            
            
             var check = function(){
                 
                
                 
                canvas.width=document.body.clientWidth;
                canvas.height=document.body.clientHeight-8;
                 
                ctx.fillStyle = "black";
                ctx.fillRect(0, 0, canvas.width, canvas.height); 
                
                const camSpeed = 15;
                const currentMap = game.maps[game.currentmap];

                if (keyState.w) currentMap.cameray += camSpeed;
                if (keyState.s) currentMap.cameray -= camSpeed;
                if (keyState.a) currentMap.camerax += camSpeed;
                if (keyState.d) currentMap.camerax -= camSpeed;
                
                
                
                
                game.updateanimation(ctx);
                    
                guard =game.getobjecttype("guard"); 
                worker =game.getobjecttype("worker"); 
                
                if(guard!=null){
                    for(let i=0;i<guard.objects.length;i++){

                        guard.objects[i].selectable=true;
                        
                        if ( guard.objects[i].direction === "up")  guard.objects[i].animation = 0;
                        else if ( guard.objects[i].direction === "right")  guard.objects[i].animation = 1;
                        else if ( guard.objects[i].direction === "down")  guard.objects[i].animation = 2;
                        else if ( guard.objects[i].direction === "left")  guard.objects[i].animation = 3;
                        
                        

                    }
                    for(let i=0;i<worker.objects.length;i++){

                        worker.objects[i].selectable=true;
                        
                        if ( worker.objects[i].direction === "up")  worker.objects[i].animation = 0;
                        else if ( worker.objects[i].direction === "right")  {worker.objects[i].animation = 1;worker.objects[i].fliped=false;}
                        else if ( worker.objects[i].direction === "down")  worker.objects[i].animation = 2;
                        else if ( worker.objects[i].direction === "left") { worker.objects[i].animation = 1;worker.objects[i].fliped=true;}
                        
                        

                    }
                    
                    
                    
                
                }
                 
                 
                 
                window.requestAnimationFrame(check);   
            };check();
            
        </script>
    </body>
</html>
