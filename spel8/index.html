
<html>
    <head>
        <meta name="viewport" content="user-scalable=no, shrink-to-fit=no">
        <meta charset="utf-8">
        <meta name="keywords" content="mobilspel, mobilegames, js games, javascript games">
        <link rel="icon" href="images/guarddown1.png" type="image/vnd.microsoft.icon" />
	<title>Test4</title>
        
        <script src="js/Game4.js"></script>
        
        
        
        
    </head>
    <body>
        
        
        <div id="build-ui" style="
  position: fixed;
  bottom: 0;
  left: 0;
  width: 100%;
  background: rgba(0,0,0,0.8);
  padding: 10px;
  display: none;
  flex-direction: row;
  justify-content: center;
  gap: 10px;
  z-index: 1000;
">
  <button id="build-base-btn" style="
    font-size: 16px;
    padding: 10px 20px;
    background: darkgreen;
    color: white;
    border: none;
    border-radius: 5px;
  ">Bygg bas</button>
</div>
        
        
        
        <canvas id="myCanvas" width="10" height="10" style="border:0px solid black"></canvas>
        
        <script>

            const canvas = document.getElementById("myCanvas");
            const ctx = canvas.getContext("2d");
            document.getElementById("myCanvas").style.margin = "-8px -8px -8px -8px";
            document.getElementById("myCanvas").style.width=window.innerWidth;
            document.getElementById("myCanvas").style.height=window.innerHeight;

            game = new Game4("Spelet");
            var audio = new Audio('sounds/wow.mp3');
            audio.loop = true;
             
             const context = new (window.AudioContext || window.webkitAudioContext)();
             const audio2 = async url => {   
             const source = context.createBufferSource(); 
                const audioBuffer = await fetch(url)
                  .then(res => res.arrayBuffer())
                  .then(ArrayBuffer => context.decodeAudioData(ArrayBuffer)); 
                source.buffer = audioBuffer;
                source.connect(context.destination);
                source.start();
            };
            window.allowSelection = function() {
                return !buildMode; // tillåt bara selektion när man inte bygger
            };
            
            document.addEventListener("touchstart" , function(e) {
                e.preventDefault();
                    try{if(audio.paused){ 
                        audio.play();
                    }
                    }catch(error){};
                    if(context.state === 'suspended'){context.suspend();context.resume();}           
            });

            
            
            document.addEventListener("visibilitychange", event => {
                if (document.visibilityState === "visible") {
                        audio.pause();audio.src = 'sounds/wow.mp3';context.resume();
                        
                }
                else {
                   audio.pause(); audio.src = "";context.suspend();
              }
          });

           
            
            
            let keysPressed = {};
                document.addEventListener('click', (event) => {
        
               
                try{if(audio.paused){ 
                        audio.play();
                    }
                }catch(error){};
             });

            
            let keyState = {
                w: false,
                a: false,
                s: false,
                d: false
            };
            
            document.addEventListener("keydown", function(e) {
                if (e.key === "w") keyState.w = true;
                if (e.key === "a") keyState.a = true;
                if (e.key === "s") keyState.s = true;
                if (e.key === "d") keyState.d = true;
            });

            document.addEventListener("keyup", function(e) {
                if (e.key === "w") keyState.w = false;
                if (e.key === "a") keyState.a = false;
                if (e.key === "s") keyState.s = false;
                if (e.key === "d") keyState.d = false;
            });
            let buildMode = false;
            let buildType = null;
            let ghostBuilding = null;
            let pendingBuilds = [];
            let selectedWorkersBeforeBuild = [];
            let selectedWorkers = [];
            let lastTouchPos = null;
            
            
            document.getElementById("build-base-btn").addEventListener("click", function() {
            buildMode = true;
            buildType = "base";
            selectedWorkersBeforeBuild = game.getAllObjectsoftype(game.getobjecttype("worker")).filter(o => o.selected );
            game.getAllObjects().forEach(o => {
                if (!selectedWorkersBeforeBuild.includes(o)) {
                    o.selected = false;
                }
            });
            ghostBuilding = game.addobject(game.getobjecttype("base"), 0, 0, 150, 150, 0, false);
            ghostBuilding.ghost = true;
            ghostBuilding.selectable = false;
        });
            
            
            
            
            document.addEventListener("touchmove", function(e) {
                                if (e.target.closest("#build-ui")) {return;}
                if (e.touches.length >= 2 && buildMode) {
                    cancelBuildMode();
                    return;
                }
                
                
    
              if (buildMode && ghostBuilding) {
    let zoomFactor = 1 + (1 * game.maps[game.currentmap].zoom / 100);
    let touch = e.touches[0];
    lastTouchPos = {
        x: touch.clientX / zoomFactor - game.maps[game.currentmap].camerax - ghostBuilding.dimx / 2,
        y: touch.clientY / zoomFactor - game.maps[game.currentmap].cameray - ghostBuilding.dimy / 2
    };
    ghostBuilding.x = lastTouchPos.x;
    ghostBuilding.y = lastTouchPos.y;
    isPlacingBuilding = true;
}
            
            
            });
            
            document.addEventListener("touchend", function(e) {
                
                selectedWorkers2 = game.getAllObjectsoftype(game.getobjecttype("worker")).filter(o => o.selected );
                for (let w of selectedWorkers2) {
                            w.workobject=null;
                            w.returning=false;
                            w.deliveryTarget=null;
                }
                
                 if(ghostBuilding!=null&&isBuildPlacementValid(ghostBuilding)==false){return;}
        
                if (buildMode && ghostBuilding) {
                    const currentMap = game.maps[game.currentmap];
                    const x = ghostBuilding.x;
                    const y = ghostBuilding.y;

                    
                  
                    ghostBuilding.ghost = false;
                    ghostBuilding.selectable = true;
                    ghostBuilding.canMove=false;
                    isPlacingBuilding = false;
                    pendingBuilds.push(ghostBuilding);
                    
                                            // Tilldela sparade workers detta bygge:
                        for (let w of selectedWorkersBeforeBuild) {
                            w.targetX = ghostBuilding.x;
                            w.targetY = ghostBuilding.y;
                            w.buildingTarget = ghostBuilding;
                        }

                        // Rensa och avsluta
                        selectedWorkersBeforeBuild = [];
                        buildMode = false;
                        buildType = null;
                        ghostBuilding = null;
                }
                
                
                
                
                
                
                
                
                
                
            });
            
            document.addEventListener("contextmenu", function(e) {
                e.preventDefault(); // förhindra browserns meny
                
                
                if (buildMode) {
            
                    cancelBuildMode();
                }
            });

            
            document.addEventListener("mousemove", function(e) {
                cursorX = e.clientX;
                cursorY = e.clientY;
                lastTouchPos = null; // ← detta säger "vi är i PC-läge"
            });
            document.addEventListener("mousedown", function(e) {
                selectedWorkers2 = game.getAllObjectsoftype(game.getobjecttype("worker")).filter(o => o.selected );
                for (let w of selectedWorkers2) {
                            w.workobject=null;
                            w.returning=false;
                            w.deliveryTarget=null;
                        }
                
                
                if(isBuildPlacementValid(ghostBuilding)==false)return;
                
                if (e.button === 2 && buildMode) {
                    e.preventDefault(); // hindra fokus/kontext
                    return; // inget mer körs
                }
                
                
                if (buildMode && ghostBuilding) {
                    const currentMap = game.maps[game.currentmap];
                    const x = ghostBuilding.x;
                    const y = ghostBuilding.y;

                    
                  
                    ghostBuilding.ghost = false;
                    ghostBuilding.selectable = true;
                    ghostBuilding.canMove=false;
                    
                    pendingBuilds.push(ghostBuilding);
                    
                                            // Tilldela sparade workers detta bygge:
                        for (let w of selectedWorkersBeforeBuild) {
                            w.targetX = ghostBuilding.x;
                            w.targetY = ghostBuilding.y;
                            w.buildingTarget = ghostBuilding;
                        }

                        // Rensa och avsluta
                        selectedWorkersBeforeBuild = [];
                        buildMode = false;
                        buildType = null;
                        ghostBuilding = null;
                }
            });
            
            
            
            
            
             var check = function(){
                 
                
                 
                canvas.width=document.body.clientWidth;
                canvas.height=document.body.clientHeight-8;
                 
                ctx.fillStyle = "black";
                ctx.fillRect(0, 0, canvas.width, canvas.height); 
                
                const camSpeed = 15;
                const currentMap = game.maps[game.currentmap];

                if (keyState.w) currentMap.cameray += camSpeed;
                if (keyState.s) currentMap.cameray -= camSpeed;
                if (keyState.a) currentMap.camerax += camSpeed;
                if (keyState.d) currentMap.camerax -= camSpeed;
                
                
                
                
                let anyWorkerSelected = false;
                if (game.maps.length > 0) {
                    const workers = game.getobjecttype("worker");
                    if (workers) {
                        anyWorkerSelected = workers.objects.some(o => o.selected);
                    }
                }
                document.getElementById("build-ui").style.display = anyWorkerSelected ? "flex" : "none";
                
                
                game.updateanimation(ctx);
                    
                guard =game.getobjecttype("guard"); 
                worker =game.getobjecttype("worker"); 
                 tree =game.getobjecttype("tree"); 
                 goldmine =game.getobjecttype("goldmine"); 
                
                if (buildMode && ghostBuilding&& lastTouchPos === null) {
                    let zoomFactor = 1 + (1 * game.maps[game.currentmap].zoom / 100);
                    ghostBuilding.x = cursorX / zoomFactor - game.maps[game.currentmap].camerax - ghostBuilding.dimx / 2;
                    ghostBuilding.y = cursorY / zoomFactor - game.maps[game.currentmap].cameray - ghostBuilding.dimy / 2;
                }
                
                
                
                
                
                
                
                
                if(guard!=null){
                    
                    selectedWorkers = game.getAllObjectsoftype(game.getobjecttype("worker")).filter(o => o.selected );
                    for(let i=0;i<goldmine.objects.length;i++){
                    
                        goldmine.objects[i].selectable=true;
                        goldmine.objects[i].canMove=false;
                    
                        if(goldmine.objects[i].mousepressed==true&&anyWorkerSelected){

                            for (let w of selectedWorkers) {

                                w.workobject=goldmine.objects[i];
                            }
                        }


                    }
                    
                    
                    for(let i=0;i<guard.objects.length;i++){

                        guard.objects[i].selectable=true;
                        
                        if ( guard.objects[i].direction === "up")  guard.objects[i].animation = 0;
                        else if ( guard.objects[i].direction === "right")  guard.objects[i].animation = 1;
                        else if ( guard.objects[i].direction === "down")  guard.objects[i].animation = 2;
                        else if ( guard.objects[i].direction === "left")  guard.objects[i].animation = 3;
                        
                        

                    }
                    for(let i=0;i<worker.objects.length;i++){

                        worker.objects[i].selectable=true;
                        
                        if ( worker.objects[i].direction === "up")  worker.objects[i].animation = 0;
                        else if ( worker.objects[i].direction === "right")  {worker.objects[i].animation = 1;worker.objects[i].fliped=false;}
                        else if ( worker.objects[i].direction === "down")  worker.objects[i].animation = 2;
                        else if ( worker.objects[i].direction === "left") { worker.objects[i].animation = 1;worker.objects[i].fliped=true;}
                        
                        
                         for (let j = 0; j < pendingBuilds.length; j++) {
                            let building = pendingBuilds[j];

                            if (game.collideswithanoterobject(worker.objects[i],building)) {
                                building.buildProgress = (building.buildProgress || 0) + 1;
                                
                                if(worker.objects[i].animation==0)worker.objects[i].animation = 3;
                                if(worker.objects[i].animation==1&&worker.objects[i].fliped==false)worker.objects[i].animation = 4;
                                if(worker.objects[i].animation==2)worker.objects[i].animation = 5;
                                if(worker.objects[i].animation==1&&worker.objects[i].fliped==true)worker.objects[i].animation = 4;
                                
                                 // bygg-animation

                                if (building.buildProgress > 1000) {
                                    // Klar – ta bort från pendingBuilds
                                    pendingBuilds.splice(j, 1);
                                    building.buildProgress = null;
                                    worker.objects[i].buildingTarget = null;
                                    worker.objects[i].animation = 0; // idle
                                    building.animation=1;
                                }
                                
                            }
                        }
                        if(worker.objects[i].workobject!=null&&worker.objects[i].returning==false){
                            
                         
                            worker.objects[i].targetX = worker.objects[i].workobject.x;
                            worker.objects[i].targetY = worker.objects[i].workobject.y;
                            
                            
                            
                        
                            
                            
                            
                            if (game.collideswithanoterobject(worker.objects[i],worker.objects[i].workobject)&&worker.objects[i].counter<202) {
                                worker.objects[i].animation=100;
                                worker.objects[i].counter++;
                                
                            }
                            if (worker.objects[i].counter > 200) {
                                // Hitta närmsta base
                                
                                let bases = game.getAllObjectsoftype(game.getobjecttype("base")).filter(b => b.buildProgress == null);
                                let closest = null;
                                let closestDist = Infinity;
                                for (let b of bases) {
                                    let dx = worker.objects[i].x - b.x;
                                    let dy = worker.objects[i].y - b.y;
                                    let dist = Math.sqrt(dx * dx + dy * dy);
                                    if (dist < closestDist) {
                                        closestDist = dist;
                                        closest = b;
                                    }
                                }

                                if (closest) {
                                    
                                    worker.objects[i].targetX = closest.x;
                                    worker.objects[i].targetY = closest.y;
                                    worker.objects[i].returning = true; // ny flagga
                                    worker.objects[i].deliveryTarget = closest;
                                }

                                
                            }
                            
                            
                        }
                   
                        if (worker.objects[i].returning && worker.objects[i].deliveryTarget) {
                            
                            if(worker.objects[i].animation==0)worker.objects[i].animation = 6;
                            if(worker.objects[i].animation==1&&worker.objects[i].fliped==false)worker.objects[i].animation = 7;
                            if(worker.objects[i].animation==2)worker.objects[i].animation = 8;
                            if(worker.objects[i].animation==1&&worker.objects[i].fliped==true)worker.objects[i].animation = 7;
                            
                            
                            
               
                            
                            
                            
                            if (game.collideswithanoterobject(worker.objects[i],worker.objects[i].deliveryTarget)) {
                                // Levererat resurser!
                                worker.objects[i].returning = false;
                                worker.objects[i].deliveryTarget = null;
                                worker.objects[i].counter = 0;
                                worker.objects[i].animation = 0; // idle
                                
                               
                                
                                
                                // (Valfritt) Öka guldmängd här
                                // gold += 10;
                            }
                        }
                        
                        
                        
                        

                    }
                    
                    
                    
                
                }

                 
                 
                window.requestAnimationFrame(check);   
            };check();
            
            function isBuildPlacementValid(o) {
                if (!o || !o.collideslistan) return false;
                return o.collideslistan.length === 0;
            }
            function cancelBuildMode() {
   
                
                if (ghostBuilding) {
                    
                    game.removeobject(game.getobjecttype("base"),ghostBuilding); // ⬅️ Viktigt!
                    ghostBuilding = null;
                }
                buildMode = false;
                buildType = null;
                selectedWorkersBeforeBuild = [];
                isPlacingBuilding = false;
                console.log("Byggläge avbrutet");
            }
           
        </script>
    </body>
</html>
